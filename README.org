#+title: Pants OCaml Backend
#+author: std23

* Overview

This is a custom [[https://www.pantsbuild.org][Pants]] backend for OCaml that adds OCaml language support to the Pants build system. It compiles OCaml sources to executables with support for multiple compilation platforms.

* Features

- Compile OCaml modules (~.ml~/.mli~) to object files (~.cmo~/.cmi~ for bytecode, ~.cmx~/.cmi~ for native)
- Package-level compilation with automatic dependency ordering via ~ocamldep~
- Link executables with ocamlfind package support
- Multi-platform compilation support:
  - ~bytecode~: Uses ~ocamlc~, produces ~.byte~ files (default, most compatible)
  - ~native~: Uses ~ocamlopt~, produces native executables (best performance)
  - ~js_of_ocaml~: Uses ~ocamlc~ + ~js_of_ocaml~, produces ~.js~ files for web/Node.js
- Support for generated sources via Pants ~adhoc_tool~ targets
- Fine-grained caching and parallel execution via the Pants engine

* Installation

Add to your ~pants.toml~:

#+begin_src toml
[GLOBAL]
backend_packages = [
    "pants.core",
    "pants.backend.adhoc",  # Required for generated_sources support
    "ocaml",  # This package
]
#+end_src

* Quick Start

Create a simple OCaml project:

#+begin_src ocaml
(* src/greeter.ml *)
let say_hello name =
  print_endline ("Hello, " ^ name ^ "!")
#+end_src

#+begin_src ocaml
(* src/main.ml *)
let () =
  Greeter.say_hello "World"
#+end_src

Define your BUILD file:

#+begin_src python
# src/BUILD
ocaml_package(
    name="greeter",
    sources=["*.ml", "*.mli"],
)

ocaml_binary(
    name="hello",
    dependencies=["greeter"],
    entry_source="main.ml",
)
#+end_src

Build and run:

#+begin_src bash
./pants package src:hello
./dist/hello.byte
#+end_src

* Target Types

** ~ocaml_module~ (Legacy)

Single OCaml module compiled to ~.cmo~/.cmi~. Kept for compatibility.

** ~ocaml_library~ (Legacy)

Aggregates module/library dependencies. Logical grouping only.

** ~ocaml_package~ (Recommended)

Package-level target that recursively scans sources and compiles them using ~ocamldep~ for correct dependency ordering.

Fields:
- ~sources~: Source file globs (default: ~"**/*.ml"~ and ~"**/*.mli"~)
- ~dependencies~: Package names (resolve to ~//{name}:{name}~ internally or external ocamlfind packages)
- ~exposed~: Public module names (empty = all modules exposed)
- ~generated_sources~: Addresses of ~adhoc_tool~ targets that generate ~.ml~/~.mli~ files
- ~compiler_flags~: Extra flags for the compiler

** ~ocaml_binary~

Links an executable from package dependencies with platform support.

Fields:
- ~dependencies~: Package names for compilation closure
- ~entry_source~: Path to the ~.ml~ file used as entrypoint
- ~platform~: Compilation target platform (default: ~bytecode~)
  - ~bytecode~: Produce bytecode executable (~.byte~)
  - ~native~: Produce native executable
  - ~js_of_ocaml~: Produce JavaScript file (~.js~)
- ~packages~: External ocamlfind packages
- ~link_flags~: Extra flags for the linker

* Configuration

Configure OCaml tool paths via ~pants.toml~:

#+begin_src toml
[ocaml-tools]
ocamlfind = "ocamlfind"
ocamldep = "ocamldep"
ocamlopt = "ocamlopt"
js_of_ocaml = "js_of_ocaml"
bash = "/bin/bash"
#+end_src

The backend automatically sets up ~PATH~, ~HOME~, and ~OPAMROOT~ for tool processes.

* Examples

** Multi-Package Project

#+begin_src python
# src/utils/BUILD
ocaml_package(
    name="utils",
    sources=["*.ml"],
    exposed=["List", "String"],
)
#+end_src

#+begin_src python
# src/core/BUILD
ocaml_package(
    name="core",
    dependencies=["utils"],  # Resolves to //utils:utils internally
    sources=["*.ml"],
    packages=["str"],  # External ocamlfind package
)
#+end_src

** Multi-Platform Binaries

#+begin_src ocaml
(* src/handler.ml *)
let handle_request () =
  print_endline "Processing request..."
#+end_src

#+begin_src python
# src/BUILD
ocaml_package(
    name="handler_pkg",
    sources=["*.ml"],
)

# Bytecode executable (default)
ocaml_binary(
    name="handler_bytecode",
    dependencies=["handler_pkg"],
    entry_source="handler.ml",
    platform="bytecode",
)

# Native executable (faster)
ocaml_binary(
    name="handler_native",
    dependencies=["handler_pkg"],
    entry_source="handler.ml",
    platform="native",
)

# JavaScript for web/Node.js
ocaml_binary(
    name="handler_js",
    dependencies=["handler_pkg"],
    entry_source="handler.ml",
    platform="js_of_ocaml",
)
#+end_src

Build the binaries:

#+begin_src bash
# Build bytecode (default platform can be omitted)
./pants package src:handler_bytecode
# Output: dist/handler_bytecode.byte

# Build native
./pants package src:handler_native
# Output: dist/handler_native

# Build JavaScript
./pants package src:handler_js
# Output: dist/handler_js.js
#+end_src

** Generated Sources

Use ~adhoc_tool~ to generate OCaml sources:

#+begin_src python
# BUILD
adhoc_tool(
    name="gen_protocol",
    executable="/path/to/codegen",
    output_files=["protocol.ml", "protocol.mli"],
)

ocaml_package(
    name="app",
    sources=["*.ml"],
    generated_sources=[":gen_protocol"],
)
#+end_src

* Common Commands

#+begin_src bash
# Check OCaml file dependencies
./pants check ::

# Compile a specific target
./pants check //path/to:target

# Build an OCaml binary
./pants package //path/to:binary_target

# List all OCaml packages
./pants filter :: --target-type=ocaml_package

# List all OCaml binaries
./pants filter :: --target-type=ocaml_binary
#+end_src

* How It Works

The backend uses Pants' engine for fine-grained caching and parallel execution:

1. **Dependency Resolution**: Named dependencies resolve to internal packages (~//{name}:{name}~) or external ocamlfind packages
2. **Compilation Order**: ~ocamldep -sort~ computes correct module compilation order within packages
3. **Platform Dispatch**: Binary linking dispatches to the appropriate compiler based on the ~platform~ field:
   - ~bytecode~: Links with ~ocamlc~ to produce ~.byte~ files
   - ~native~: Links with ~ocamlopt~ to produce native executables
   - ~js_of_ocaml~: Links with ~ocamlc~, then converts with ~js_of_ocaml~ to produce ~.js~ files
4. **Incremental Builds**: Only recompiles changed modules and their dependents
5. **Parallel Execution**: Independent packages compile in parallel

Compiled artifacts are stored under ~__pants_ocaml__/~ in the working directory.

* Requirements

- Pants 2.x
- OCaml toolchain: ~ocamlfind~, ~ocamldep~, ~ocamlc~, ~ocamlopt~
- (Optional) ~js_of_ocaml~ for JavaScript platform
- (Optional) OPAM for package management

* Development

This project uses [[https://github.com/astral-sh/uv][uv]] as the dependency manager for fast Python package installation and management.

**Installing uv:**

#+begin_src bash
# macOS/Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Or with Homebrew (macOS)
brew install uv

# Or with pip
pip install uv
#+end_src

**Setting up the development environment:**

#+begin_src bash
# Install dependencies
uv pip install -e ".[dev]"
#+end_src

**Running tests:**

# Run tests
uv run pytest

# Run tests with coverage
uv run pytest --cov=ocaml --cov-report=term

# Run specific test file
uv run pytest tests/unit/test_target_types.py

# Run a specific test
uv run pytest tests/unit/test_target_types.py::TestOCamlPlatformField::test_valid_choices
#+end_src

**Backend development workflow:**

#+begin_src bash
# Verify the backend loads
uv run python -c "from ocaml import register; print('OK')"

# Check syntax of all Python files
python3 -m py_compile *.py

# Run type checking (optional)
uv run mypy ocaml/ --ignore-missing-imports
#+end_src

**Project structure:**

#+begin_example
.                        # Project root
├── ocaml/               # Source files (in project root for Pants backend)
│   ├── __init__.py
│   ├── register.py
│   ├── target_types.py
│   ├── rules.py
│   ├── providers.py
│   └── subsystem.py
├── tests/               # Test suite
│   ├── unit/           # Unit tests
│   └── integration/    # Integration tests
├── .github/            # CI/CD workflows
├── pyproject.toml      # Project configuration with uv support
└── README.org          # This file
#+end_example

* License

SPDX-License-Identifier: Apache-2.0
