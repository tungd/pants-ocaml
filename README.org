#+title: Pants OCaml Backend
#+author: std23

* Overview

This is a custom [[https://www.pantsbuild.org][Pants]] backend for OCaml that adds OCaml language support to the Pants build system. It compiles OCaml sources to executables with support for multiple compilation platforms.

* Features

- Compile OCaml modules (~.ml~/.mli~) to object files (~.cmo~/.cmi~ for bytecode, ~.cmx~/.cmi~ for native)
- Package-level compilation with automatic dependency ordering via ~ocamldep~
- Link executables with ocamlfind package support
- Multi-platform compilation support:
  - ~bytecode~: Uses ~ocamlc~, produces ~.byte~ files (default, most compatible)
  - ~native~: Uses ~ocamlopt~, produces native executables (best performance)
- ~js_of_ocaml~: Uses ~ocamlc~ + ~js_of_ocaml --effects=cps~, produces ~.js~ files for web/Node.js
- Fine-grained caching and parallel execution via the Pants engine

* Installation

Add to your ~pants.toml~:

#+begin_src toml
[GLOBAL]
backend_packages = [
    "pants.core",
    "ocaml",  # This package
]
#+end_src

* Quick Start

Create a simple OCaml project:

#+begin_src ocaml
(* src/greeter.ml *)
let say_hello name =
  print_endline ("Hello, " ^ name ^ "!")
#+end_src

#+begin_src ocaml
(* src/main.ml *)
let () =
  Greeter.say_hello "World"
#+end_src

Define your BUILD file:

#+begin_src python
# src/BUILD
ocaml_package(
    name="greeter",
)

ocaml_binary(
    name="hello",
    dependencies=["greeter"],
    entry="main.ml",
)
#+end_src

Build and run:

#+begin_src bash
./pants package src:hello
./dist/hello.byte
#+end_src

* Target Types

** ~ocaml_package~ (Recommended)

Package-level target that recursively scans sources and compiles them using ~ocamldep~ for correct dependency ordering.

Fields:
- ~sources~: Source file globs (default: ~"**/*.ml"~ and ~"**/*.mli"~)
- ~dependencies~: Package names (resolve to ~//{name}:{name}~ internally or external ocamlfind packages)
- ~exposed~: Public module names (empty = all modules exposed)
- ~compiler_flags~: Extra flags for the compiler

** ~ocaml_binary~

Links an executable from package dependencies with platform support.

Fields:
- ~dependencies~: Package names for compilation closure
- ~entry~: Path to the ~.ml~ file used as entrypoint
- ~platform~: Compilation target platform (default: ~bytecode~)
  - ~bytecode~: Produce bytecode executable (~.byte~)
  - ~native~: Produce native executable
  - ~js_of_ocaml~: Produce JavaScript file (~.js~)
- ~packages~: External ocamlfind packages
- ~link_flags~: Extra flags for the linker

* Configuration

Configure OCaml tool paths via ~pants.toml~:

#+begin_src toml
[ocaml-tools]
ocamlfind = "ocamlfind"
ocamldep = "ocamldep"
ocamlopt = "ocamlopt"
js_of_ocaml = "js_of_ocaml"
bash = "/bin/bash"
#+end_src

The backend automatically sets up ~PATH~, ~HOME~, and ~OPAMROOT~ for tool processes.
For ~platform="js_of_ocaml"~, the backend invokes ~js_of_ocaml~ with ~--effects=cps~.

* Examples

** Multi-Package Project

#+begin_src python
# src/utils/BUILD
ocaml_package(
    name="utils",
    exposed=["List", "String"],
)
#+end_src

#+begin_src python
# src/core/BUILD
ocaml_package(
    name="core",
    dependencies=["utils"],  # Resolves to //utils:utils internally
    packages=["str"],  # External ocamlfind package
)
#+end_src

** Multi-Platform Binaries

#+begin_src ocaml
(* src/handler.ml *)
let handle_request () =
  print_endline "Processing request..."
#+end_src

#+begin_src python
# src/BUILD
ocaml_package(
    name="handler_pkg",
)

# Bytecode executable (default)
ocaml_binary(
    name="handler_bytecode",
    dependencies=["handler_pkg"],
    entry="handler.ml",
    platform="bytecode",
)

# Native executable (faster)
ocaml_binary(
    name="handler_native",
    dependencies=["handler_pkg"],
    entry="handler.ml",
    platform="native",
)

# JavaScript for web/Node.js
ocaml_binary(
    name="handler_js",
    dependencies=["handler_pkg"],
    entry="handler.ml",
    platform="js_of_ocaml",
)
#+end_src

Build the binaries:

#+begin_src bash
# Build bytecode (default platform can be omitted)
./pants package src:handler_bytecode
# Output: dist/handler_bytecode.byte

# Build native
./pants package src:handler_native
# Output: dist/handler_native

# Build JavaScript
./pants package src:handler_js
# Output: dist/handler_js.js
#+end_src

* Common Commands

#+begin_src bash
# Check OCaml file dependencies
./pants check ::

# Compile a specific target
./pants check //path/to:target

# Build an OCaml binary
./pants package //path/to:binary_target

# List all OCaml packages
./pants filter :: --target-type=ocaml_package

# List all OCaml binaries
./pants filter :: --target-type=ocaml_binary
#+end_src

* How It Works

The backend uses Pants' engine for fine-grained caching and parallel execution:

1. **Dependency Resolution**: Named dependencies resolve to internal packages (~//{name}:{name}~) or external ocamlfind packages
2. **Compilation Order**: ~ocamldep -sort~ computes correct module compilation order within packages
3. **Platform Dispatch**: Binary linking dispatches to the appropriate compiler based on the ~platform~ field:
   - ~bytecode~: Links with ~ocamlc~ to produce ~.byte~ files
   - ~native~: Links with ~ocamlopt~ to produce native executables
   - ~js_of_ocaml~: Links with ~ocamlc~, then converts with ~js_of_ocaml --effects=cps~ to produce ~.js~ files
4. **Incremental Builds**: Only recompiles changed modules and their dependents
5. **Parallel Execution**: Independent packages compile in parallel

Compiled artifacts are stored under ~__pants_ocaml__/~ in the working directory.

* Requirements

- Pants 2.x
- OCaml toolchain: ~ocamlfind~, ~ocamldep~, ~ocamlc~, ~ocamlopt~
- (Optional) ~js_of_ocaml~ for JavaScript platform (must support ~--effects=cps~)
- (Optional) OPAM for package management

* Development

This repository uses Pants-native plugin testing.

**Plugin testing:**

#+begin_src bash
# Run all plugin tests
pants test tests::

# Run unit tests only
pants test tests/unit::

# Run integration tests only
pants test tests/integration::
#+end_src

**Useful local commands:**

#+begin_src bash
# Show Pants version
pants --version

# List targets
pants list ::

# Run quality checks used in CI
grep -r "OCamlWorkerArtifact" . --include="*.py" --exclude-dir="tests"
grep -r "worker_entry_js" . --include="*.py" --exclude-dir="tests"
#+end_src

**Project structure:**

#+begin_example
.                        # Project root
├── ocaml/               # Source files (in project root for Pants backend)
│   ├── __init__.py
│   ├── register.py
│   ├── target_types.py
│   ├── rules.py
│   ├── providers.py
│   └── subsystem.py
├── tests/               # Test suite
│   ├── unit/           # Unit tests
│   └── integration/    # Integration tests
├── .github/            # CI/CD workflows
├── pants.toml          # Pants configuration for plugin development/testing
├── pyproject.toml      # Python package metadata (no Pants PyPI runtime dep)
└── README.org          # This file
#+end_example

* License

SPDX-License-Identifier: Apache-2.0
