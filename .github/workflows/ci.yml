name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Set up Python ${{ matrix.python-version }}
        run: |
          uv python install ${{ matrix.python-version }}
          uv venv --python ${{ matrix.python-version }}

      - name: Install OCaml toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y opam ocaml

      - name: Install js_of_ocaml
        run: |
          opam init -y
          eval $(opam env)
          opam install -y js_of_ocaml

      - name: Install Python dependencies with uv
        run: |
          uv pip install -e ".[dev]"

      - name: Verify backend loads
        run: |
          uv run python -c "from ocaml import register; print('Backend loads successfully')"
          uv run python -c "from ocaml.target_types import OCamlPackage, OCamlBinary; print('Target types imported')"

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Set up Python
        run: |
          uv python install 3.10
          uv venv --python 3.10

      - name: Install dependencies with uv
        run: |
          uv pip install -e .

      - name: Validate no worker artifact references
        run: |
          if grep -r "OCamlWorkerArtifact" . --include="*.py" 2>/dev/null; then
            echo "::error::Found OCamlWorkerArtifact references in code"
            exit 1
          else
            echo "Clean - no worker artifact references"
          fi

      - name: Validate platform field exists
        run: |
          uv run python -c "from ocaml.target_types import OCamlPlatformField; print('OCamlPlatformField imported successfully')"

      - name: Validate platform field choices
        run: |
          uv run python -c "from ocaml.target_types import OCamlPlatformField; f = OCamlPlatformField(); assert f.valid_choices == ('bytecode', 'native', 'js_of_ocaml'), f'Unexpected choices: {f.valid_choices}'; print('Platform choices validated:', f.valid_choices)"

      - name: Validate provider has output_path (not bytecode_path)
        run: |
          uv run python << 'EOF'
          from ocaml.providers import BuiltOCamlBinary
          fields = [f.name for f in BuiltOCamlBinary.__dataclass_fields__.values()]
          assert 'output_path' in fields, "BuiltOCamlBinary should have 'output_path' field"
          assert 'bytecode_path' not in fields, "BuiltOCamlBinary should not have 'bytecode_path' field (should be 'output_path')"
          assert 'platform' in fields, "BuiltOCamlBinary should have 'platform' field"
          print("Provider fields validated:", fields)
          EOF

      - name: Validate ocamlopt in subsystem
        run: |
          uv run python << 'EOF'
          from ocaml.subsystem import OCamlToolsSubsystem
          assert hasattr(OCamlToolsSubsystem, 'ocamlopt'), "OCamlToolsSubsystem should have 'ocamlopt' option"
          assert hasattr(OCamlToolsSubsystem, 'js_of_ocaml'), "OCamlToolsSubsystem should still have 'js_of_ocaml' option"
          print("Subsystem validated - has ocamlopt and js_of_ocaml")
          EOF

      - name: Validate target registration
        run: |
          uv run python << 'EOF'
          from ocaml.register import target_types
          types = target_types()
          type_aliases = {t.alias for t in types}
          assert 'ocaml_worker_artifact' not in type_aliases, "OCamlWorkerArtifact should not be in registered target types"
          assert 'ocaml_binary' in type_aliases, "OCamlBinary should be in registered target types"
          print("Target types validated:", type_aliases)
          EOF
