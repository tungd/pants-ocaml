name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  plugin-tests:
    name: Plugin Tests and Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install OCaml toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y opam ocaml ocaml-findlib libcurl4-openssl-dev pkg-config

      - name: Install OCaml packages
        run: |
          opam init -y
          eval "$(opam env)"
          opam install -y js_of_ocaml conf-libcurl curl
          echo "PATH=$PATH" >> "$GITHUB_ENV"
          echo "OPAMROOT=$(opam var root)" >> "$GITHUB_ENV"
          echo "OPAM_SWITCH_PREFIX=$(opam var prefix)" >> "$GITHUB_ENV"

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Pants
        uses: pantsbuild/actions/init-pants@v10
        with:
          gha-cache-key: v0
          named-caches-hash: ${{ hashFiles('**/pants.toml') }}

      - name: Validate no worker artifact references
        run: |
          if grep -r "OCamlWorkerArtifact" . --include="*.py" --exclude-dir="tests" 2>/dev/null; then
            echo "::error::Found OCamlWorkerArtifact references in code"
            exit 1
          fi
          echo "Clean - no worker artifact references"

      - name: Validate no worker entry references
        run: |
          if grep -r "worker_entry_js" . --include="*.py" --exclude-dir="tests" 2>/dev/null; then
            echo "::error::Found worker_entry_js references in code"
            exit 1
          fi
          echo "Clean - no worker entry references"

      - name: Run plugin tests
        run: |
          set -euo pipefail

          command -v ocamlfind
          command -v ocamldep
          command -v ocamlopt
          command -v js_of_ocaml
          ocamlfind query curl

          # Use scie-pants only; retry bootstrap/tests with exponential-ish backoff.
          for i in 1 2 3 4 5; do
            if pants --version && pants --filter-target-type=python_test list tests:: > /tmp/python_tests.txt; then
              if [ ! -s /tmp/python_tests.txt ]; then
                echo "::error::No python_test targets discovered under tests::"
                exit 1
              fi
              cat /tmp/python_tests.txt

              if pants test tests::; then
                exit 0
              fi
            fi
            echo "::warning::Pants bootstrap/test attempt ${i} failed; clearing nce cache and retrying."
            rm -rf "$HOME/.cache/nce" || true
            rm -rf "$HOME/.cache/pants/setup" || true
            sleep $((i * 15))
          done

          echo "::error::Pants bootstrap/test failed after retries."
          exit 1
